<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GIRLS MOOD</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ec4899">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');
        
        :root { --primary: #ec4899; }
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #fdf2f8; 
            color: #831843;
            height: 100dvh;
            display: flex; flex-direction: column; overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-primary {
            background: var(--primary); color: white; font-weight: 800; padding: 16px; border-radius: 16px;
            text-transform: uppercase; width: 100%; letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3); transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.96); }
        .input-style {
            background: #fff; border: 1px solid #fbcfe8; width: 100%; padding: 16px; border-radius: 16px;
            outline: none; font-weight: 600; margin-bottom: 12px;
        }
        .card {
            background: #fff; padding: 20px; border-radius: 24px;
            box-shadow: 0 4px 20px rgba(236, 72, 153, 0.05); margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.5);
        }
        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #ec4899; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <section id="auth-view" class="absolute inset-0 z-50 flex flex-col justify-center px-8 bg-[#fdf2f8]">
        <div class="text-center mb-10">
            <h1 class="text-5xl font-black italic tracking-tighter text-pink-500">GIRLS MOOD</h1>
            <p class="text-xs font-bold uppercase tracking-widest text-pink-400 mt-2">Le QG des copines</p>
        </div>
        <input type="email" id="email" placeholder="Email..." class="input-style">
        <input type="password" id="password" placeholder="Mot de passe..." class="input-style">
        <button id="btn-login" class="btn-primary mt-4">Entrer</button>
        <button id="btn-register" class="text-xs text-center w-full text-pink-400 font-bold underline mt-6 py-4">CrÃ©er un compte</button>
    </section>

    <div id="app-view" class="hidden flex-col h-full relative">
        <header class="p-6 flex justify-between items-center bg-white/80 backdrop-blur-md sticky top-0 z-20 border-b border-pink-100">
            <h2 class="font-black italic text-xl text-pink-500">GIRLS MOOD</h2>
            <button id="btn-logout" class="bg-pink-100 text-pink-600 p-2 rounded-full"><i data-lucide="log-out" class="w-4 h-4"></i></button>
        </header>

        <main class="flex-1 overflow-y-auto p-4 pb-24 no-scrollbar">
            <div class="card bg-gradient-to-br from-white to-pink-50 border-pink-100">
                <h3 class="text-[10px] font-black uppercase text-pink-400 mb-3 tracking-widest">âœ¨ Nouveau Dossier</h3>
                <input type="text" id="event-name" placeholder="Nom (ex: Anniv Lou)" class="input-style mb-2">
                <div class="flex gap-2">
                    <input type="date" id="event-date" class="input-style w-1/2 text-xs">
                    <input type="text" id="event-dress" placeholder="Dress Code" class="input-style w-1/2 text-xs">
                </div>
                <button id="btn-create" class="btn-primary mt-2 text-xs">CrÃ©er</button>
            </div>
            <div id="events-list" class="space-y-4 mt-6"></div>
        </main>
    </div>

    <div id="modal-event" class="hidden fixed inset-0 z-[100] bg-[#fdf2f8] flex flex-col">
        <div class="p-6 bg-white/80 backdrop-blur-md border-b border-pink-100 flex justify-between items-center sticky top-0">
            <h2 id="modal-title" class="font-black text-2xl italic uppercase text-pink-600 truncate pr-4">Titre</h2>
            <button id="btn-close-modal" class="bg-slate-100 p-2 rounded-full text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 pb-24 no-scrollbar">
            <div id="inspo-grid" class="space-y-5 mb-10"></div>
        </div>

        <div class="absolute bottom-0 w-full p-4 bg-white border-t border-pink-100 pb-8">
            <label for="file-upload" class="btn-primary flex items-center justify-center gap-2 cursor-pointer active:scale-95">
                <i data-lucide="camera" class="w-5 h-5"></i>
                <span id="upload-text">AJOUTER UNE PHOTO</span>
                <div id="upload-loader" class="loader hidden"></div>
            </label>
            <input type="file" id="file-upload" accept="image/*" class="hidden">
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, arrayUnion, arrayRemove, orderBy, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgLVoCp13V7xanqR7oO_2uGwiTpCaFpAY",
            authDomain: "loudressing2.firebaseapp.com",
            projectId: "loudressing2",
            storageBucket: "loudressing2.firebasestorage.app",
            messagingSenderId: "877161870915",
            appId: "1:877161870915:web:963f894f6be7d63bc006f6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUser = null;
        let currentEventId = null;

        // AUTH
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('flex');
                loadEvents();
            } else {
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('flex');
            }
        });

        document.getElementById('btn-login').onclick = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } catch(e){alert(e.message);} };
        document.getElementById('btn-register').onclick = async () => { try { await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } catch(e){alert(e.message);} };
        document.getElementById('btn-logout').onclick = () => signOut(auth);

        // CREATE EVENT
        document.getElementById('btn-create').onclick = async () => {
            const name = document.getElementById('event-name').value;
            if (!name) return alert("Nom manquant !");
            await addDoc(collection(db, 'events'), {
                name: name, date: document.getElementById('event-date').value, dressCode: document.getElementById('event-dress').value,
                creator: currentUser.email, createdAt: Date.now()
            });
            document.getElementById('event-name').value = "";
            alert("âœ… Dossier crÃ©Ã© !");
        };

        function loadEvents() {
            onSnapshot(query(collection(db, 'events'), orderBy('createdAt', 'desc')), (snap) => {
                const list = document.getElementById('events-list'); list.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    const div = document.createElement('div');
                    div.className = "card border-l-4 border-pink-400 active:scale-95 transition cursor-pointer";
                    div.innerHTML = `<h3 class="font-black text-xl text-pink-900 capitalize">${data.name}</h3><p class="text-xs text-pink-400 font-bold mt-1">ðŸ“… ${data.date||'...'} â€¢ ðŸ‘— ${data.dressCode||'Libre'}</p>`;
                    div.onclick = () => openEvent(d.id, data.name);
                    list.appendChild(div);
                });
            });
        }

        // --- UPLOAD MAGIQUE SANS STORAGE (Base64) ---
        document.getElementById('file-upload').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Afficher chargement
            document.getElementById('upload-text').innerText = "COMPRESSION...";
            document.getElementById('upload-loader').classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = (readerEvent) => {
                const img = new Image();
                img.onload = async () => {
                    // COMPRESSION DE L'IMAGE (Pour ne pas faire exploser la base de donnÃ©es)
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // On rÃ©duit la taille max Ã  800px
                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 800;
                    if (width > height) {
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    } else {
                        if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Conversion en texte (Base64) qualitÃ© moyenne (0.6)
                    const dataUrl = canvas.toDataURL("image/jpeg", 0.6);

                    try {
                        // Envoi direct dans Firestore (Pas besoin de Storage !)
                        await addDoc(collection(db, 'events', currentEventId, 'inspos'), {
                            url: dataUrl, // L'image est stockÃ©e ici en texte
                            user: currentUser.email.split('@')[0], 
                            email: currentUser.email,
                            createdAt: Date.now(), 
                            likes: [], 
                            comments: []
                        });
                        alert("Photo ajoutÃ©e ! ðŸ“¸");
                    } catch (error) {
                        alert("Erreur : Photo trop lourde ou connexion lente.");
                    } finally {
                        document.getElementById('upload-text').innerText = "AJOUTER UNE PHOTO";
                        document.getElementById('upload-loader').classList.add('hidden');
                        document.getElementById('file-upload').value = "";
                    }
                }
                img.src = readerEvent.target.result;
            }
            reader.readAsDataURL(file);
        };

        function openEvent(id, name) {
            currentEventId = id;
            document.getElementById('modal-title').innerText = name;
            document.getElementById('modal-event').classList.remove('hidden');
            
            onSnapshot(query(collection(db, 'events', id, 'inspos'), orderBy('createdAt', 'desc')), (snap) => {
                const grid = document.getElementById('inspo-grid'); grid.innerHTML = "";
                if(snap.empty) grid.innerHTML = "<p class='text-center opacity-40 text-xs font-bold mt-10'>Aucune photo... Clique en bas ! ðŸ‘‡</p>";
                
                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    const isLiked = (d.likes || []).includes(currentUser.uid);
                    
                    const div = document.createElement('div');
                    div.className = "card p-0 overflow-hidden shadow-lg border-none";
                    div.innerHTML = `
                        <div class="relative">
                            <img src="${d.url}" class="w-full max-h-96 object-cover bg-gray-100">
                            ${d.email === currentUser.email ? `<button class="btn-del absolute top-2 right-2 bg-black/50 text-white w-8 h-8 rounded-full flex items-center justify-center"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                        </div>
                        <div class="p-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] font-black uppercase text-pink-300">${d.user}</span>
                                <div class="flex gap-3">
                                    <button class="btn-like flex items-center gap-1 font-bold text-xs ${isLiked ? 'text-pink-500' : 'text-slate-400'}"><i data-lucide="heart" class="w-4 h-4 ${isLiked?'fill-pink-500':''}"></i> ${d.likes?.length||0}</button>
                                    <button class="btn-comment flex items-center gap-1 font-bold text-xs text-slate-400"><i data-lucide="message-circle" class="w-4 h-4"></i> Avis</button>
                                </div>
                            </div>
                            <div class="space-y-1 bg-pink-50/50 rounded-lg p-2 ${(d.comments||[]).length===0?'hidden':''}">${(d.comments||[]).map(c=>`<div class="text-[10px]"><span class="font-bold text-pink-700">${c.user}:</span> ${c.text}</div>`).join('')}</div>
                        </div>
                    `;
                    
                    if(d.email === currentUser.email) div.querySelector('.btn-del').onclick = () => { if(confirm('Supprimer ?')) deleteDoc(doc(db,'events',id,'inspos',docSnap.id)); };
                    div.querySelector('.btn-like').onclick = async () => { const r = doc(db,'events',id,'inspos',docSnap.id); if(isLiked) updateDoc(r,{likes:arrayRemove(currentUser.uid)}); else updateDoc(r,{likes:arrayUnion(currentUser.uid)}); };
                    div.querySelector('.btn-comment').onclick = async () => { const t = prompt("Ton avis ?"); if(t) updateDoc(doc(db,'events',id,'inspos',docSnap.id),{comments:arrayUnion({user:currentUser.email.split('@')[0], text:t})}); };
                    grid.appendChild(div);
                });
                lucide.createIcons();
            });
        }
        
        document.getElementById('btn-close-modal').onclick = () => document.getElementById('modal-event').classList.add('hidden');
        lucide.createIcons();
    </script>
</body>
</html>
