<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GIRLS MOOD V6</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');
        :root { --bg: #f8fafc; --text: #0f172a; --primary: #ec4899; }
        [data-theme="dark"] { --bg: #0f172a; --text: #f8fafc; --primary: #f472b6; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; transition: 0.3s; }
        .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        [data-theme="dark"] .glass { background: rgba(30,41,59,0.95); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .input-style { background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); width: 100%; padding: 12px; border-radius: 12px; color: var(--text); outline: none; }
        [data-theme="dark"] .input-style { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .card { background: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 10px; }
        [data-theme="dark"] .card { background: rgba(255,255,255,0.05); }
        .btn-primary { background: var(--primary); color: white; font-weight: 800; padding: 12px; border-radius: 12px; text-transform: uppercase; width: 100%; }
        .chat-bubble { max-width: 75%; padding: 10px; border-radius: 14px; font-size: 13px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <section id="auth-view" class="flex flex-col justify-center px-8 h-full space-y-4 absolute inset-0 bg-[var(--bg)] z-50">
        <h1 class="text-4xl font-black italic text-center">GIRLS<span style="color:var(--primary)">MOOD</span></h1>
        <p class="text-center text-xs opacity-50">Version Diagnostique V6</p>
        <input type="email" id="email" placeholder="Email" class="input-style">
        <input type="password" id="password" placeholder="Mot de passe" class="input-style">
        <button onclick="login()" class="btn-primary">Se connecter</button>
        <button onclick="register()" class="text-xs text-center underline opacity-50">Cr√©er un compte</button>
    </section>

    <div id="app-view" class="hidden flex-col h-full relative">
        <header class="p-4 glass flex justify-between items-center z-10">
            <h2 class="font-black italic">GIRLS<span style="color:var(--primary)">MOOD</span></h2>
            <div class="flex gap-2">
                <button onclick="toggleTheme()" id="theme-btn" class="text-xl">üåô</button>
                <button onclick="auth.signOut()" class="text-[10px] bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-full font-bold">SORTIR</button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 pb-24">
            <section id="tab-events">
                <div class="card space-y-3 border-2 border-[var(--primary)] border-opacity-20">
                    <h3 class="text-xs font-black uppercase opacity-50">1. Cr√©er un dossier</h3>
                    <input type="text" id="event-name" placeholder="Nom (ex: Anniv Samia)" class="input-style font-bold">
                    <div class="flex gap-2">
                        <input type="date" id="event-date" class="input-style w-1/2 text-xs">
                        <input type="text" id="event-dress" placeholder="Dress Code" class="input-style w-1/2 text-xs">
                    </div>
                    <button onclick="createEvent()" class="btn-primary text-xs">Cr√©er l'√©v√©nement</button>
                </div>
                <div id="events-list" class="mt-6 space-y-3"></div>
            </section>

            <section id="tab-chat" class="hidden h-full flex flex-col">
                <div id="chat-box" class="flex-1 overflow-y-auto pb-4"></div>
                <div class="flex gap-2 pt-2">
                    <input type="text" id="msg-input" placeholder="Message..." class="input-style">
                    <button onclick="sendMsg()" class="bg-[var(--primary)] text-white w-12 rounded-xl">‚û§</button>
                </div>
            </section>
        </main>

        <nav class="glass fixed bottom-0 w-full grid grid-cols-2 py-4 z-20">
            <button onclick="switchTab('events')" class="text-center opacity-50 nav-btn font-bold text-xs uppercase">üìÖ Events</button>
            <button onclick="switchTab('chat')" class="text-center opacity-50 nav-btn font-bold text-xs uppercase">üí¨ Chat</button>
        </nav>
    </div>

    <div id="modal-event" class="hidden fixed inset-0 z-50 bg-[var(--bg)] flex flex-col overflow-hidden">
        <div class="p-4 glass flex justify-between items-center">
            <h2 id="modal-title" class="font-black text-xl italic uppercase" style="color:var(--primary)">Titre</h2>
            <button onclick="closeModal()" class="text-2xl opacity-50">‚úï</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 pb-20">
            <div class="bg-[var(--primary)] bg-opacity-10 p-4 rounded-xl mb-6 border border-[var(--primary)]">
                <h3 class="text-xs font-black uppercase mb-2" style="color:var(--primary)">2. Ajoute tes tenues ici üëá</h3>
                <div class="flex gap-2">
                    <input type="text" id="inspo-link" placeholder="Lien image..." class="input-style bg-white dark:bg-black/20">
                    <button onclick="addInspo()" class="bg-[var(--primary)] text-white font-bold px-4 rounded-xl text-xl shadow-lg">+</button>
                </div>
            </div>
            <div id="inspo-grid" class="space-y-6"></div>
        </div>
    </div>

    <script>
        // --- THEME ---
        function toggleTheme() {
            const body = document.body;
            if(body.getAttribute('data-theme') === 'dark') { body.removeAttribute('data-theme'); localStorage.setItem('theme', 'light'); }
            else { body.setAttribute('data-theme', 'dark'); localStorage.setItem('theme', 'dark'); }
        }
        if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

        // --- FIREBASE CONFIG (Loudressing2) ---
        const firebaseConfig = {
          apiKey: "AIzaSyAgLVoCp13V7xanqR7oO_2uGwiTpCaFpAY",
          authDomain: "loudressing2.firebaseapp.com",
          projectId: "loudressing2",
          storageBucket: "loudressing2.firebasestorage.app",
          messagingSenderId: "877161870915",
          appId: "1:877161870915:web:963f894f6be7d63bc006f6"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;
        let currentEventId = null;

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('flex');
                loadEvents();
            } else {
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('flex');
            }
        });
        async function login() { 
            try { await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value); } 
            catch(e){ alert("Erreur connexion : " + e.message); } 
        }
        async function register() { 
            try { await auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value); } 
            catch(e){ alert("Erreur inscription : " + e.message); } 
        }

        // --- EVENTS (AVEC ALERTES DE DIAGNOSTIC) ---
        async function createEvent() {
            const name = document.getElementById('event-name').value;
            const date = document.getElementById('event-date').value;
            const dress = document.getElementById('event-dress').value;
            
            if(!name) return alert("‚ùå Erreur : Le nom de l'√©v√©nement est vide !");
            
            // Petit message pour dire que √ßa charge
            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerText;
            btn.innerText = "Cr√©ation en cours...";
            
            try {
                // On essaie d'√©crire dans la base de donn√©es
                await db.collection('events').add({
                    name: name, date: date, dressCode: dress,
                    creator: currentUser.email.split('@')[0], createdAt: Date.now()
                });
                
                alert("‚úÖ Succ√®s ! √âv√©nement cr√©√©. Regarde la liste en dessous.");
                document.getElementById('event-name').value = "";
            } catch (e) {
                // SI √áA ECHOUE, √áA TE DIRA POURQUOI ICI :
                alert("üõë ERREUR CRITIQUE : " + e.message + "\n\n(As-tu bien activ√© Firestore en mode Test ?)");
            }
            
            btn.innerText = originalText;
        }

        function loadEvents() {
            db.collection('events').orderBy('createdAt', 'desc').onSnapshot(snap => {
                const list = document.getElementById('events-list');
                if(snap.empty) {
                    list.innerHTML = "<p class='text-center opacity-30 text-xs'>Aucun √©v√©nement trouv√©.</p>";
                    return;
                }
                list.innerHTML = snap.docs.map(doc => `
                    <div onclick="openEvent('${doc.id}', '${doc.data().name}')" class="card cursor-pointer active:scale-95 transition border-l-4 border-[var(--primary)]">
                        <div class="flex justify-between items-center">
                            <h3 class="font-black text-xl capitalize">${doc.data().name}</h3>
                            <span class="text-xl">‚ûî</span>
                        </div>
                        <div class="text-xs opacity-60 mt-1">
                            üìÖ ${doc.data().date || '...'} ‚Ä¢ üëó ${doc.data().dressCode || '...'}
                        </div>
                    </div>
                `).join('');
            });
            
            // Chargement Chat
            db.collection('chat').orderBy('date', 'asc').limit(50).onSnapshot(snap => {
                const box = document.getElementById('chat-box');
                box.innerHTML = snap.docs.map(doc => {
                    const isMe = doc.data().email === currentUser.email;
                    return `<div class="chat-bubble ${isMe ? 'bg-[var(--primary)] text-white self-end' : 'bg-gray-200 dark:bg-gray-700 self-start'}">
                        ${!isMe ? `<div class="font-bold text-[9px] opacity-50 mb-1">${doc.data().user}</div>` : ''}
                        ${doc.data().text}
                    </div>`;
                }).join('');
                box.scrollTop = box.scrollHeight;
            });
        }

        // --- DASHBOARD ---
        function openEvent(id, name) {
            currentEventId = id;
            document.getElementById('modal-title').innerText = name;
            document.getElementById('modal-event').classList.remove('hidden');
            
            db.collection('events').doc(id).collection('inspos').orderBy('createdAt', 'desc').onSnapshot(snap => {
                const grid = document.getElementById('inspo-grid');
                if(snap.empty) { grid.innerHTML = "<p class='text-center opacity-40 text-xs'>Aucune inspo... Ajoute la premi√®re !</p>"; return; }
                
                grid.innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    const likes = d.likes || [];
                    const isLiked = likes.includes(currentUser.uid);
                    return `
                    <div class="card overflow-hidden p-0">
                        <img src="${d.url}" class="w-full max-h-80 object-cover" onerror="this.src='https://placehold.co/400?text=Erreur+Lien'">
                        <div class="p-3">
                            <div class="flex justify-between items-center">
                                <p class="text-[9px] uppercase font-bold opacity-50">Post√© par ${d.user}</p>
                                <button onclick="deleteInspo('${doc.id}', '${d.email}')" class="opacity-30 text-xs">üóë</button>
                            </div>
                            <div class="flex gap-4 mt-3">
                                <button onclick="toggleLike('${doc.id}', ${isLiked})" class="flex items-center gap-1 font-bold text-xs ${isLiked ? 'text-[var(--primary)]' : 'opacity-50'}">
                                    <span class="text-lg">${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span> ${likes.length}
                                </button>
                                <button onclick="addComment('${doc.id}')" class="flex items-center gap-1 font-bold text-xs opacity-50">
                                    <span class="text-lg">üí¨</span> Avis
                                </button>
                            </div>
                            <div class="mt-3 space-y-1 bg-gray-50 dark:bg-black/10 p-2 rounded-lg ${(d.comments || []).length === 0 ? 'hidden' : ''}">
                                ${(d.comments || []).map(c => `<div class="text-[10px]"><span class="font-bold">${c.user}:</span> ${c.text}</div>`).join('')}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            });
        }

        async function addInspo() {
            const url = document.getElementById('inspo-link').value;
            if(!url) return alert("Il faut un lien !");
            await db.collection('events').doc(currentEventId).collection('inspos').add({
                url: url, user: currentUser.email.split('@')[0], email: currentUser.email,
                createdAt: Date.now(), likes: [], comments: []
            });
            document.getElementById('inspo-link').value = "";
        }
        async function toggleLike(docId, isLiked) {
            const ref = db.collection('events').doc(currentEventId).collection('inspos').doc(docId);
            if(isLiked) await ref.update({ likes: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
            else await ref.update({ likes: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
        }
        async function addComment(docId) {
            const txt = prompt("Ton avis ?");
            if(txt) await db.collection('events').doc(currentEventId).collection('inspos').doc(docId).update({
                comments: firebase.firestore.FieldValue.arrayUnion({ user: currentUser.email.split('@')[0], text: txt })
            });
        }
        async function deleteInspo(id, email) {
            if(currentUser.email === email && confirm("Supprimer ?")) await db.collection
